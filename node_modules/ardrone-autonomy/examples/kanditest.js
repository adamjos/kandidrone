var df = require('dateformat')
  , arDrone = require('ar-drone')
  , arDroneConstants = require('ar-drone/lib/constants')
  , autonomy = require('../')
  , client = arDrone.createClient()
  , ctrl = autonomy.control(client)
  , mission  = autonomy.createMission(client, ctrl)
  ;

//var gotox = 0;
//var gotoy = 0;


function navdata_option_mask(c) {
  return 1 << c;
}

// From the SDK.
var navdata_options = (
    navdata_option_mask(arDroneConstants.options.DEMO)
  | navdata_option_mask(arDroneConstants.options.VISION_DETECT)
  | navdata_option_mask(arDroneConstants.options.MAGNETO)
  | navdata_option_mask(arDroneConstants.options.WIFI)
);

// Connect and configure the drone
mission.client().config('general:navdata_demo', true);
mission.client().config('general:navdata_visionDetect',true);
mission.client().config('general:navdata_options', navdata_options);
mission.client().config('video:video_channel', 3);
mission.client().config('detect:detect_type', 12);

mission.log("../../../dataAnalysis/Logfiler/all/mission-" + df(new Date(), "yyyy-mm-dd_hh-MM-ss") + ".txt");

// Land on ctrl-c
var exiting = false;
process.on('SIGINT', function() {
    if (exiting) {
        process.exit(0);
    } else {
        console.log('Got SIGINT. Landing, press Control-C again to force exit.');
        exiting = true;
        mission.control().disable();
        mission.client().land(function() {
            process.exit(0);
        });
    }
});

ctrl.on('Tag Detected', function(tag) {
  console.log(tag);
  //gotox = tag.x;
  //gotoy = tag.y;

});

ctrl.on('Got values', function(values) {
  console.log(values);
})

client.on('batteryChange', function(battery) {
  console.log(battery)
});


mission.takeoff()
    /* INSERT SEQUENCE */
    
    	.zero()
    	.go({x:0,y:0,z:2,yaw:0})
    	.hovertwo(2000)
      .go({x:2.5,y:0,z:2,yaw:0})
      .hovertwo(5000)
    	//.go({x:2.5,y:0,z:1,yaw:0})
    	//.hovertwo(2000)
      //.go({x:0,y:0,z:1,yaw:0})
      //.hovertwo(2000)
      //.go({x:gotox,y:gotoy,z:1,yaw:0})
      .land();


mission.run(function (err, result) {
    if (err) {
        console.trace("Oops, something bad happened: %s", err.message);
        mission.client().stop();
        mission.client().land();
    } else {
        console.log("We are done! - Dargons Rules!");
        process.exit(0);
    }
});

